{% extends "base.html" %}

{% block title %}إدارة الأماكن - {{ super() }}{% endblock %}

{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2">إدارة الأماكن</h1>
    <a href="{{ url_for('add_location') }}" class="btn btn-primary">
        <i class="bi bi-plus-lg"></i> إضافة مكان جديد
    </a>
</div>

<div class="mb-3">
    <input type="text" class="form-control" id="searchLocations" 
           placeholder="🔍 البحث في الأماكن..." onkeyup="filterLocations()">
</div>

{% if locations %}
{% set current_neighborhood = '' %}
{% set current_category = '' %}

{% for location in locations %}
    {% if location.neighborhood != current_neighborhood %}
        {% if current_neighborhood != '' %}
                    </div>
                </div>
            </div>
        {% endif %}
        {% set current_neighborhood = location.neighborhood %}
        <div class="neighborhood-section mb-4">
            <h4 class="text-primary border-bottom pb-2">
                <i class="bi bi-house-door"></i> {{ location.neighborhood }}
            </h4>
    {% endif %}
    
    {% if location.category != current_category %}
        {% if current_category != '' %}
                </div>
            </div>
        {% endif %}
        {% set current_category = location.category %}
        <div class="category-section mb-3">
            <h5 class="text-secondary mb-2">
                <i class="bi bi-tag"></i> {{ location.category }}
            </h5>
            <div class="row">
    {% endif %}
    
    <div class="col-md-6 col-lg-4 mb-2 location-item">
        <div class="card border-0 shadow-sm h-100">
            <div class="card-body p-2 d-flex flex-column">
                <div class="flex-grow-1">
                    <h6 class="card-title mb-1">{{ location.name }}</h6>
                    {% if location.coordinates %}
                    <small class="text-muted">
                        <i class="bi bi-geo-alt"></i> {{ location.coordinates }}
                    </small>
                    {% endif %}
                </div>
                <div class="mt-2">
                    <div class="btn-group w-100">
                        <a href="{{ url_for('edit_location', location_id=location.id) }}" class="btn btn-sm btn-outline-primary">
                            <i class="bi bi-pencil"></i>
                        </a>
                        <button type="button" class="btn btn-sm btn-outline-danger" 
                                onclick="confirmDeleteLocation({{ location.id }}, '{{ location.name }}')">
                            <i class="bi bi-trash"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
{% endfor %}

{% if current_category != '' %}
            </div>
        </div>
{% endif %}
{% if current_neighborhood != '' %}
    </div>
{% endif %}

{% else %}
<div class="text-center py-5">
    <i class="bi bi-geo-alt display-1 text-muted"></i>
    <h3 class="mt-3 text-muted">لا توجد أماكن مضافة بعد</h3>
    <p class="text-muted">ابدأ بإضافة أول مكان</p>
    <a href="{{ url_for('add_location') }}" class="btn btn-primary">
        <i class="bi bi-plus-lg"></i> إضافة مكان جديد
    </a>
</div>
{% endif %}

<!-- نماذج حذف مخفية -->
{% for location in locations %}
<form id="deleteLocationForm{{ location.id }}" method="POST" action="{{ url_for('delete_location', location_id=location.id) }}" style="display: none;">
</form>
{% endfor %}

{% endblock %}

{% block scripts %}
<script>
function filterLocations() {
    const searchTerm = document.getElementById('searchLocations').value.toLowerCase();
    const locationItems = document.querySelectorAll('.location-item');
    
    locationItems.forEach(item => {
        const title = item.querySelector('.card-title').textContent.toLowerCase();
        if (title.includes(searchTerm)) {
            item.style.display = 'block';
        } else {
            item.style.display = 'none';
        }
    });
}

function confirmDeleteLocation(locationId, locationName) {
    if (confirm('هل أنت متأكد من حذف المكان "' + locationName + '"؟\nهذا الإجراء لا يمكن التراجع عنه!')) {
        document.getElementById('deleteLocationForm' + locationId).submit();
    }
}
</script>
{% endblock %}